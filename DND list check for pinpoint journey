import boto3
import csv
from io import StringIO

# Initialize the S3 client
s3 = boto3.client('s3')

def lambda_handler(event, context):
    # Print the incoming event for debugging
    print("Received event: ", event)

    # Extract phone number and endpoint ID from the event
    phone_number = event.get('phone_number')
    endpoint_id = event.get('endpoint_id')  # Assuming endpoint ID is passed in the event
    bucket_name = 'your-s3-bucket-name'
    file_key = 'path/to/your/file.csv'  # S3 file key (location of the CSV file in S3)

    # Fetch the CSV file from S3
    response = s3.get_object(Bucket=bucket_name, Key=file_key)
    csv_content = response['Body'].read().decode('utf-8')

    # Read the CSV content
    csv_reader = csv.reader(StringIO(csv_content))

    # Default result
    is_dialable = True

    # Check if the phone number exists in the CSV (Do Not Call list)
    for row in csv_reader:
        if phone_number in row:
            is_dialable = False
            break

    # Prepare response in Pinpoint format
    pinpoint_response = {
        endpoint_id: {
            'EventAttributes': {
                'Dialable': 'true' if is_dialable else 'false'
            }
        }
    }

    # Return the response for Pinpoint
    return {
        'statusCode': 200,
        'body': pinpoint_response
    }
